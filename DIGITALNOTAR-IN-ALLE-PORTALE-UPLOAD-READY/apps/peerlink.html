<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PeerLink - P2P</title>
<h1 style="position: absolute; left: -9999px;">PeerLink - P2P</h1>
  <link rel="stylesheet" href="../styles.css">
  <style>
    .peer-grid{display:grid; gap:var(--spacing-lg); grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
    video{width:100%; aspect-ratio:16/9; background:#000; border-radius:var(--radius-md)}
    .controls{display:flex; gap:var(--spacing-sm); flex-wrap:wrap}
    input,button{padding:.6rem .9rem; border-radius:var(--radius-sm); border:1px solid var(--outline); background:var(--surface); color:var(--on-surface)}
    button{cursor:pointer}
    .card{background:var(--surface); border:1px solid var(--outline); border-radius:var(--radius-lg); padding:var(--spacing-lg)}
  </style>

        <style>
            .navigation-buttons {
                position: fixed;
                bottom: 20px;
                right: 20px;
                display: flex;
                gap: 10px;
                z-index: 1000;
            }
            
            .nav-btn {
                width: 50px;
                height: 50px;
                border-radius: 50%;
                border: none;
                background: var(--primary, #007bff);
                color: white;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                transition: all 0.3s ease;
            }
            
            .nav-btn:hover {
                transform: scale(1.1);
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            }
            
            .nav-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
            }
            
            .nav-btn svg {
                width: 20px;
                height: 20px;
            }
        </style>

    </head>
<body>
    
        <header class="top-app-bar">
            <div class="top-app-bar-content">
                <button class="icon-button" onclick="window.history.back()" title="Zurück" title="Action Button">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                </button>
                <h1 class="top-app-bar-title">Navigation</h1>
                <div class="top-app-bar-actions"><button class="icon-button" onclick="window.history.forward()" title="Vorwärts" title="Action Button">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M4 11v2h12.17l-5.59 5.59L12 20l8-8-8-8-1.41 1.41L16.17 11H4z"/></svg>
                    </button>
                    
                    <button class="icon-button" onclick="window.history.forward()" title="Vorwärts" title="Action Button">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M4 11v2h12.17l-5.59 5.59L12 20l8-8-8-8-1.41 1.41L16.17 11H4z"/></svg>
                    </button>
                </div>
            </div>
        </header>
        <main class="main-content">

  <div class="main-content">
    <div class="card">
      <h2>PeerLink – einfache P2P‑Session</h2>
      <div class="controls">
        <input id="room" placeholder="Raum-ID (z.B. team42)" aria-label="Input Field">
        <button id="join" title="Action Button">Beitreten</button>
        <button id="leave" disabled title="Action Button">Verlassen</button>
        <button id="share" disabled title="Action Button">Bildschirm teilen</button>
        <span class="badge" id="status">getrennt</span>
      </div>
      <div class="peer-grid">
        <video id="local" autoplay playsinline muted></video>
        <video id="remote" autoplay playsinline></video>
      </div>
    </div>
  </div>

  <script>
    const wsURL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.hostname + (location.port ? ':'+location.port : '') + '/';
    let pc, ws, roomId, localStream;
    const el = id => document.getElementById(id);
    const setStatus = (t)=> el('status').textContent = t;

    async function openMedia(){
      if (localStream) return localStream;
      localStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:true });
      el('local').srcObject = localStream;
      return localStream;
    }

    function connectWS(){
      return new Promise((resolve, reject) => {
        ws = new WebSocket(wsURL);
        ws.onopen = resolve;
        ws.onerror = reject;
        ws.onmessage = async (ev) => {
          const msg = JSON.parse(ev.data||'{}');
          if (msg.type === 'signal'){ await handleSignal(msg.payload || {}); }
          if (msg.type === 'peer-joined'){ if (pc) makeOffer(); }
          if (msg.type === 'peer-left'){ setStatus('wartet auf Peer'); }
          if (msg.type === 'joined'){ setStatus('verbunden'); }
        };
        ws.onclose = () => setStatus('getrennt');
      });
    }

    async function join(){
      roomId = (el('room').value || '').trim();
      if (!roomId) { alert('Bitte Raum-ID angeben'); return; }
      await openMedia();
      await connectWS();
      createPeer();
      ws.send(JSON.stringify({ type:'join', room:roomId }));
      el('leave').disabled = false;
      el('share').disabled = false;
    }

    function leave(){
      if (ws) ws.send(JSON.stringify({ type:'leave' }));
      if (pc) pc.close();
      pc = null;
      setStatus('getrennt');
      el('leave').disabled = true;
      el('share').disabled = true;
    }

    function createPeer(){
      pc = new RTCPeerConnection({ iceServers: [{ urls:'stun:stun.l.google.com:19302' }] });
      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
      pc.ontrack = (e) => { el('remote').srcObject = e.streams[0]; };
      pc.onicecandidate = (e) => {
        if (e.candidate) ws?.send(JSON.stringify({ type:'signal', room:roomId, payload:{ candidate:e.candidate } }));
      };
    }

    async function makeOffer(){
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      ws?.send(JSON.stringify({ type:'signal', room:roomId, payload:{ sdp: pc.localDescription } }));
    }

    async function handleSignal({ sdp, candidate }){
      if (sdp){
        await pc.setRemoteDescription(new RTCSessionDescription(sdp));
        if (sdp.type === 'offer'){
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          ws?.send(JSON.stringify({ type:'signal', room:roomId, payload:{ sdp: pc.localDescription } }));
        }
      } else if (candidate){
        try { await pc.addIceCandidate(new RTCIceCandidate(candidate)); } catch {}
      }
    }

    async function shareScreen(){
      const stream = await navigator.mediaDevices.getDisplayMedia({ video:true, audio:true });
      const track = stream.getVideoTracks()[0];
      const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
      if (sender) sender.replaceTrack(track);
      track.onended = async () => {
        const camTrack = (await openMedia()).getVideoTracks()[0];
        const s = pc.getSenders().find(s => s.track && s.track.kind === 'video');
        if (s) s.replaceTrack(camTrack);
      };
    }

    el('join').onclick = join;
    el('leave').onclick = leave;
    el('share').onclick = shareScreen;
  </script>
        </main>
    
        <script>
            // Browser Navigation Enhancement
            document.addEventListener('DOMContentLoaded', function() {
                // Navigation-Status anzeigen
                updateNavigationStatus();
                
                // Popstate Event für Browser-Navigation
                window.addEventListener('popstate', function(event) {
                    console.log('Browser Navigation:', event.state);
                    updateNavigationStatus();
                });
                
                // Navigation-Status aktualisieren
                function updateNavigationStatus() {
                    const canGoBack = window.history.length > 1;
                    const canGoForward = window.history.length > 1; // Vereinfacht
                    
                    // Back-Button aktivieren/deaktivieren
                    const backButtons = document.querySelectorAll('button[onclick*="history.back"]');
                    backButtons.forEach(btn => {
                        btn.disabled = !canGoBack;
                        btn.style.opacity = canGoBack ? '1' : '0.5';
                    });
                    
                    // Forward-Button aktivieren/deaktivieren
                    const forwardButtons = document.querySelectorAll('button[onclick*="history.forward"]');
                    forwardButtons.forEach(btn => {
                        btn.disabled = !canGoForward;
                        btn.style.opacity = canGoForward ? '1' : '0.5';
                    });
                }
                
                // Globale Navigation-Funktionen
                window.goBack = function() {
                    if (window.history.length > 1) {
                        window.history.back();
                    }
                };
                
                window.goForward = function() {
                    window.history.forward();
                };
                
                window.goHome = function() {
                    window.location.href = '/';
                };
            });
        </script>

    </body>
</html>
