<!-- TODO: Replacement character detected () - verify source encoding -->
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <title>SUBVOX WIRELESS BRIDGE - iOS/WebKit</title>
  <link rel="stylesheet" href="../styles.css">
  <link rel="manifest" href="../manifest.json">
  <meta name="theme-color" content="#FF6B35">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SUBVOX">
  <link rel="apple-touch-icon" href="../icon.png">
  <style>
    .ios-container {
      max-width: 100%;
      margin: 0 auto;
      padding: 1rem;
      -webkit-overflow-scrolling: touch;
    }
    
    .ios-header {
      background: linear-gradient(135deg, #FF6F00, #FF8A33);
      color: white;
      padding: 2rem 1rem;
      border-radius: var(--radius-lg);
      text-align: center;
      margin-bottom: 1rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .ios-controls {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .ios-button {
      background: var(--primary);
      color: var(--on-primary);
      border: none;
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    .ios-button:active {
      transform: scale(0.95);
      background: var(--secondary);
    }
    
    .ios-button:disabled {
      background: var(--outline);
      cursor: not-allowed;
      transform: none;
    }
    
    .ios-button.connected {
      background: #4CAF50;
    }
    
    .ios-button.error {
      background: #F44336;
    }
    
    .ios-status {
      background: var(--surface);
      border: 1px solid var(--outline);
      border-radius: var(--radius-lg);
      padding: 1rem;
      margin: 1rem 0;
      text-align: center;
    }
    
    .ios-status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 0.5rem;
    }
    
    .status-connected { background: #4CAF50; }
    .status-connecting { background: #FF9800; }
    .status-disconnected { background: #F44336; }
    
    .ios-token-display {
      background: var(--background);
      border: 2px solid var(--primary);
      border-radius: var(--radius-lg);
      padding: 2rem;
      margin: 1rem 0;
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
      font-size: 1.5rem;
      text-align: center;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-user-select: none;
      user-select: none;
    }
    
    .ios-token-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      margin: 1rem 0;
    }
    
    .ios-token-btn {
      background: var(--surface);
      border: 1px solid var(--outline);
      border-radius: var(--radius-md);
      padding: 1rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    .ios-token-btn:active {
      transform: scale(0.95);
      background: var(--primary-container);
    }
    
    .ios-history {
      background: var(--surface);
      border: 1px solid var(--outline);
      border-radius: var(--radius-lg);
      padding: 1rem;
      margin: 1rem 0;
      max-height: 300px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .ios-history-item {
      padding: 0.5rem;
      border-bottom: 1px solid var(--outline);
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
      font-size: 0.9rem;
    }
    
    .ios-history-item:last-child {
      border-bottom: none;
    }
    
    .ios-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin: 1rem 0;
    }
    
    .ios-stat-card {
      background: var(--surface);
      border: 1px solid var(--outline);
      border-radius: var(--radius-md);
      padding: 1rem;
      text-align: center;
    }
    
    .ios-stat-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      display: block;
    }
    
    .ios-stat-label {
      font-size: 0.8rem;
      color: var(--on-surface-variant);
      margin-top: 0.25rem;
    }
    
    .ios-haptic-feedback {
      background: var(--surface-variant);
      border-radius: var(--radius-lg);
      padding: 1rem;
      margin: 1rem 0;
    }
    
    .ios-haptic-btn {
      background: var(--primary);
      color: var(--on-primary);
      border: none;
      border-radius: var(--radius-md);
      padding: 0.75rem 1rem;
      margin: 0.25rem;
      font-size: 0.9rem;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    .ios-haptic-btn:active {
      transform: scale(0.95);
    }
    
    /* iOS-spezifische Anpassungen */
    @supports (-webkit-touch-callout: none) {
      .ios-container {
        padding-bottom: env(safe-area-inset-bottom);
      }
      
      .ios-header {
        padding-top: calc(2rem + env(safe-area-inset-top));
      }
      
      .ios-button {
        -webkit-appearance: none;
        appearance: none;
      }
    }
    
    /* Dark Mode Support */
    @media (prefers-color-scheme: dark) {
      :root {
        --primary: #FF8A33;
        --on-primary: #0B0E14;
        --background: #0F1116;
        --on-background: #ECEEF4;
        --surface: #141821;
        --on-surface: #ECEEF4;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="ios-container">
      <div class="ios-header">
        <h1>üß† SUBVOX WIRELESS BRIDGE</h1>
        <p>iOS/WebKit Integration</p>
        <div class="badge">iOS READY</div>
      </div>

      <!-- Ger√§te-Verbindungen -->
      <div class="ios-controls">
        <button class="ios-button" id="emg-btn" onclick="connectEMG()" title="Action Button">
          üí™ EMG Sensor
        </button>
        <button class="ios-button" id="switch-btn" onclick="connectSwitch()" title="Action Button">
          üéÆ BLE Switch
        </button>
        <button class="ios-button" id="eeg-btn" onclick="connectEEG()" title="Action Button">
          üß† OpenBCI/EEG
        </button>
        <button class="ios-button" id="hid-btn" onclick="connectHID()" title="Action Button">
          üñ±Ô∏è WebHID
        </button>
      </div>

      <!-- Status-Anzeige -->
      <div class="ios-status" id="connection-status">
        <div class="status-indicator status-disconnected"></div>
        <span>Keine Verbindungen aktiv</span>
      </div>

      <!-- Token-Anzeige -->
      <div class="ios-token-display" id="token-display">
        Warten auf Token...
      </div>

      <!-- Token-Grid -->
      <div class="ios-token-grid">
        <button aria-label="YES" class="ios-token-btn" onclick="sendToken('YES')" title="Action Button">YES</button>
        <button aria-label="NO" class="ios-token-btn" onclick="sendToken('NO')" title="Action Button">NO</button>
        <button aria-label="LEFT" class="ios-token-btn" onclick="sendToken('LEFT')" title="Action Button">LEFT</button>
        <button aria-label="RIGHT" class="ios-token-btn" onclick="sendToken('RIGHT')" title="Action Button">RIGHT</button>
        <button aria-label="UP" class="ios-token-btn" onclick="sendToken('UP')" title="Action Button">UP</button>
        <button aria-label="DOWN" class="ios-token-btn" onclick="sendToken('DOWN')" title="Action Button">DOWN</button>
        <button aria-label="SELECT" class="ios-token-btn" onclick="sendToken('SELECT')" title="Action Button">SELECT</button>
        <button aria-label="HELP" class="ios-token-btn" onclick="sendToken('HELP')" title="Action Button">HELP</button>
        <button aria-label="SPEAK" class="ios-token-btn" onclick="sendToken('SPEAK')" title="Action Button">SPEAK</button>
      </div>

      <!-- Haptisches Feedback -->
      <div class="ios-haptic-feedback">
        <h3>üì≥ Haptisches Feedback</h3>
        <button aria-label="Light" class="ios-haptic-btn" onclick="triggerHaptic('light')" title="Action Button">Light</button>
        <button aria-label="Medium" class="ios-haptic-btn" onclick="triggerHaptic('medium')" title="Action Button">Medium</button>
        <button aria-label="Heavy" class="ios-haptic-btn" onclick="triggerHaptic('heavy')" title="Action Button">Heavy</button>
        <button aria-label="Success" class="ios-haptic-btn" onclick="triggerHaptic('success')" title="Action Button">Success</button>
        <button aria-label="Warning" class="ios-haptic-btn" onclick="triggerHaptic('warning')" title="Action Button">Warning</button>
        <button aria-label="Error" class="ios-haptic-btn" onclick="triggerHaptic('error')" title="Action Button">Error</button>
      </div>

      <!-- Statistiken -->
      <div class="ios-stats">
        <div class="ios-stat-card">
          <span class="ios-stat-number" id="total-tokens">0</span>
          <div class="ios-stat-label">Gesamt Tokens</div>
        </div>
        <div class="ios-stat-card">
          <span class="ios-stat-number" id="tokens-per-minute">0</span>
          <div class="ios-stat-label">Tokens/Minute</div>
        </div>
        <div class="ios-stat-card">
          <span class="ios-stat-number" id="avg-latency">0ms</span>
          <div class="ios-stat-label">Durchschn. Latenz</div>
        </div>
        <div class="ios-stat-card">
          <span class="ios-stat-number" id="success-rate">100%</span>
          <div class="ios-stat-label">Erfolgsrate</div>
        </div>
      </div>

      <!-- Token-History -->
      <div class="ios-history">
        <h3>üìã Token-History</h3>
        <div id="token-history">
          <div class="ios-history-item">Token-History wird hier angezeigt...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- SUBVOX WIRELESS BRIDGE Script f√ºr iOS/WebKit -->
  <script async type="module">
// iOS/WebKit-spezifische SUBVOX-Implementierung
class SubvoxIOS extends EventTarget {
  constructor() {
    super();
    this.connections = new Map();
    this.stats = {
      totalTokens: 0,
      tokensPerMinute: 0,
      avgLatency: 0,
      successRate: 100,
      startTime: Date.now(),
      tokenHistory: []
    };
    this.setupIOSFeatures();
  }

  setupIOSFeatures() {
    // iOS-spezifische Features
    this.setupHapticFeedback();
    this.setupTouchGestures();
    this.setupWebKitAPIs();
  }

  setupHapticFeedback() {
    // Haptic Feedback f√ºr iOS
    this.hapticPatterns = {
      light: [10],
      medium: [20],
      heavy: [40],
      success: [20, 10, 20],
      warning: [20, 20, 20],
      error: [40, 20, 40]
    };
  }

  setupTouchGestures() {
    // Touch-Gesten f√ºr iOS
    let touchStartTime = 0;
    let touchStartX = 0;
    let touchStartY = 0;

    document.addEventListener('touchstart', (e) => {
      touchStartTime = Date.now();
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
    });

    document.addEventListener('touchend', (e) => {
      const touchEndTime = Date.now();
      const touchDuration = touchEndTime - touchStartTime;
      const touchEndX = e.changedTouches[0].clientX;
      const touchEndY = e.changedTouches[0].clientY;
      const deltaX = touchEndX - touchStartX;
      const deltaY = touchEndY - touchStartY;

      // Swipe-Gesten erkennen
      if (touchDuration < 300) {
        if (Math.abs(deltaX) > Math.abs(deltaY)) {
          if (deltaX > 50) {
            this.sendToken('RIGHT');
          } else if (deltaX < -50) {
            this.sendToken('LEFT');
          }
        } else {
          if (deltaY > 50) {
            this.sendToken('DOWN');
          } else if (deltaY < -50) {
            this.sendToken('UP');
          }
        }
      }

      // Tap-Gesten
      if (touchDuration < 200 && Math.abs(deltaX) < 10 && Math.abs(deltaY) < 10) {
        this.sendToken('SELECT');
      }
    });
  }

  setupWebKitAPIs() {
    // WebKit-spezifische APIs
    if ('webkitSpeechRecognition' in window) {
      this.setupSpeechRecognition();
    }

    if ('DeviceMotionEvent' in window) {
      this.setupMotionDetection();
    }
  }

  setupSpeechRecognition() {
    const recognition = new webkitSpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = false;
    recognition.lang = 'de-DE';

    recognition.onresult = (event) => {
      const result = event.results[event.results.length - 1];
      if (result.isFinal) {
        const transcript = result[0].transcript.toLowerCase().trim();
        this.processSpeechInput(transcript);
      }
    };

    recognition.onerror = (event) => {
      console.error('Speech recognition error:', event.error);
    };

    this.speechRecognition = recognition;
  }

  setupMotionDetection() {
    if (typeof DeviceMotionEvent.requestPermission === 'function') {
      DeviceMotionEvent.requestPermission().then(response => {
        if (response === 'granted') {
          window.addEventListener('devicemotion', (event) => {
            this.processMotionData(event);
          });
        }
      });
    } else {
      window.addEventListener('devicemotion', (event) => {
        this.processMotionData(event);
      });
    }
  }

  processSpeechInput(transcript) {
    const speechMap = {
      'ja': 'YES',
      'nein': 'NO',
      'links': 'LEFT',
      'rechts': 'RIGHT',
      'hoch': 'UP',
      'runter': 'DOWN',
      'ausw√§hlen': 'SELECT',
      'hilfe': 'HELP',
      'sprechen': 'SPEAK'
    };

    const token = speechMap[transcript];
    if (token) {
      this.sendToken(token);
    }
  }

  processMotionData(event) {
    const acceleration = event.acceleration;
    const threshold = 2.0;

    if (acceleration.x > threshold) {
      this.sendToken('RIGHT');
    } else if (acceleration.x < -threshold) {
      this.sendToken('LEFT');
    } else if (acceleration.y > threshold) {
      this.sendToken('DOWN');
    } else if (acceleration.y < -threshold) {
      this.sendToken('UP');
    }
  }

  async connectEMG() {
    try {
      const device = await navigator.bluetooth.requestDevice({
        filters: [{ services: ['0000ffe0-0000-1000-8000-00805f9b34fb'] }]
      });

      const server = await device.gatt.connect();
      const service = await server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
      const characteristic = await service.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');

      await characteristic.startNotifications();
      characteristic.addEventListener('characteristicvaluechanged', (event) => {
        this.processEMGData(event.target.value);
      });

      this.connections.set('emg', { device, server, service, characteristic });
      this.updateConnectionStatus('emg', 'connected');
      this.triggerHaptic('success');

    } catch (error) {
      console.error('EMG connection error:', error);
      this.updateConnectionStatus('emg', 'error');
      this.triggerHaptic('error');
    }
  }

  async connectSwitch() {
    try {
      const device = await navigator.bluetooth.requestDevice({
        acceptAllDevices: true,
        optionalServices: ['00001812-0000-1000-8000-00805f9b34fb']
      });

      const server = await device.gatt.connect();
      const service = await server.getPrimaryService('00001812-0000-1000-8000-00805f9b34fb');
      const characteristic = await service.getCharacteristic('00002a4d-0000-1000-8000-00805f9b34fb');

      await characteristic.startNotifications();
      characteristic.addEventListener('characteristicvaluechanged', (event) => {
        this.processSwitchData(event.target.value);
      });

      this.connections.set('switch', { device, server, service, characteristic });
      this.updateConnectionStatus('switch', 'connected');
      this.triggerHaptic('success');

    } catch (error) {
      console.error('Switch connection error:', error);
      this.updateConnectionStatus('switch', 'error');
      this.triggerHaptic('error');
    }
  }

  async connectEEG() {
    try {
      const ws = new WebSocket('ws://localhost:8081');
      
      ws.onopen = () => {
        this.connections.set('eeg', { ws });
        this.updateConnectionStatus('eeg', 'connected');
        this.triggerHaptic('success');
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'token') {
          this.sendToken(data.token);
        }
      };

      ws.onerror = (error) => {
        console.error('EEG connection error:', error);
        this.updateConnectionStatus('eeg', 'error');
        this.triggerHaptic('error');
      };

    } catch (error) {
      console.error('EEG connection error:', error);
      this.updateConnectionStatus('eeg', 'error');
      this.triggerHaptic('error');
    }
  }

  async connectHID() {
    try {
      if (!('hid' in navigator)) {
        throw new Error('WebHID not available');
      }

      const [device] = await navigator.hid.requestDevice({
        filters: [{ vendorId: 0x0000 }]
      });

      await device.open();
      device.addEventListener('inputreport', (event) => {
        this.processHIDData(event);
      });

      this.connections.set('hid', { device });
      this.updateConnectionStatus('hid', 'connected');
      this.triggerHaptic('success');

    } catch (error) {
      console.error('HID connection error:', error);
      this.updateConnectionStatus('hid', 'error');
      this.triggerHaptic('error');
    }
  }

  processEMGData(dataView) {
    const emgValue = dataView.getInt8(0) / 128.0;
    if (Math.abs(emgValue) > 0.12) {
      this.sendToken('SELECT');
    }
  }

  processSwitchData(dataView) {
    const buttons = dataView.getUint8(0);
    if (buttons & 1) this.sendToken('LEFT');
    if (buttons & 2) this.sendToken('RIGHT');
    if (buttons & 4) this.sendToken('UP');
    if (buttons & 8) this.sendToken('DOWN');
  }

  processHIDData(event) {
    const data = new Uint8Array(event.data.buffer);
    if (data[0] === 1) this.sendToken('SELECT');
    if (data[1] === 1) this.sendToken('HELP');
  }

  sendToken(token) {
    const action = this.mapTokenToAction(token);
    this.updateTokenDisplay(token, action);
    this.updateStats(token);
    this.addToHistory(token, action);
    this.triggerHaptic('light');

    // Event dispatch
    this.dispatchEvent(new CustomEvent('subvox-token', {
      detail: { token, action }
    }));
  }

  mapTokenToAction(token) {
    const tokenMap = {
      'YES': 'ui/confirm',
      'NO': 'ui/back',
      'LEFT': 'ui/left',
      'RIGHT': 'ui/right',
      'UP': 'ui/up',
      'DOWN': 'ui/down',
      'SELECT': 'ui/select',
      'HELP': 'access/help',
      'SPEAK': 'access/tts'
    };
    return tokenMap[token] || token;
  }

  updateTokenDisplay(token, action) {
    const display = document.getElementById('token-display');
    display.textContent = `${token} ‚Üí ${action}`;
    display.style.background = 'linear-gradient(135deg, var(--primary), var(--secondary))';
    display.style.color = 'white';

    setTimeout(() => {
      display.style.background = 'var(--background)';
      display.style.color = 'var(--on-background)';
    }, 1000);
  }

  updateStats(token) {
    this.stats.totalTokens++;
    
    const now = Date.now();
    const elapsed = (now - this.stats.startTime) / 60000;
    this.stats.tokensPerMinute = Math.round(this.stats.totalTokens / elapsed);

    document.getElementById('total-tokens').textContent = this.stats.totalTokens;
    document.getElementById('tokens-per-minute').textContent = this.stats.tokensPerMinute;
  }

  addToHistory(token, action) {
    const history = document.getElementById('token-history');
    const entry = document.createElement('div');
    entry.className = 'ios-history-item';
    entry.textContent = `[${new Date().toLocaleTimeString()}] ${token} ‚Üí ${action}`;

    history.insertBefore(entry, history.firstChild);

    while (history.children.length > 50) {
      history.removeChild(history.lastChild);
    }
  }

  updateConnectionStatus(device, status) {
    const btn = document.getElementById(`${device}-btn`);
    const statusEl = document.getElementById('connection-status');
    const indicator = statusEl.querySelector('.status-indicator');
    const text = statusEl.querySelector('span');

    btn.className = 'ios-button';
    indicator.className = 'status-indicator';

    switch(status) {
      case 'connected':
        btn.classList.add('connected');
        indicator.classList.add('status-connected');
        text.textContent = `${device.toUpperCase()} verbunden`;
        break;
      case 'connecting':
        btn.classList.add('connecting');
        indicator.classList.add('status-connecting');
        text.textContent = `Verbinde ${device.toUpperCase()}...`;
        break;
      case 'error':
        btn.classList.add('error');
        indicator.classList.add('status-disconnected');
        text.textContent = `${device.toUpperCase()} Fehler`;
        break;
      case 'disconnected':
        indicator.classList.add('status-disconnected');
        text.textContent = 'Keine Verbindungen aktiv';
        break;
    }
  }

  triggerHaptic(type) {
    if (navigator.vibrate) {
      const pattern = this.hapticPatterns[type] || [20];
      navigator.vibrate(pattern);
    }
  }
}

// Globale SUBVOX-Instanz f√ºr iOS
window.subvoxIOS = new SubvoxIOS();

// UI-Funktionen
function connectEMG() {
  window.subvoxIOS.connectEMG();
}

function connectSwitch() {
  window.subvoxIOS.connectSwitch();
}

function connectEEG() {
  window.subvoxIOS.connectEEG();
}

function connectHID() {
  window.subvoxIOS.connectHID();
}

function sendToken(token) {
  window.subvoxIOS.sendToken(token);
}

function triggerHaptic(type) {
  window.subvoxIOS.triggerHaptic(type);
}

// iOS-spezifische Initialisierung
document.addEventListener('DOMContentLoaded', function() {
  // PWA-Installation f√ºr iOS
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('../sw.js');
  }

  // iOS-spezifische Event-Listener
  window.subvoxIOS.addEventListener('subvox-token', (event) => {
    console.log('SUBVOX Token received:', event.detail);
  });

  console.log('üß† SUBVOX iOS/WebKit Integration loaded');
});
  </script>
</body>
</html>
