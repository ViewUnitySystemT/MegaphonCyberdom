<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Scanner</title>
    <link rel="stylesheet" href="../styles.css">
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        body { 
            font-family: var(--font-family); 
            background-color: var(--background); 
            color: var(--on-background); 
            padding: 20px; 
        }
        .scanner-container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: var(--surface); 
            border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-md); 
            padding: 30px; 
        }
        h1 { 
            color: var(--primary); 
            text-align: center; 
            margin-bottom: 30px; 
        }
        .scanner-section { 
            margin-bottom: 30px; 
            padding: 20px; 
            background: var(--surface-variant); 
            border-radius: var(--radius-md); 
        }
        .scanner-section h3 { 
            color: var(--on-surface); 
            margin-bottom: 15px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .video-container { 
            position: relative; 
            width: 100%; 
            max-width: 500px; 
            margin: 0 auto; 
            background: #000; 
            border-radius: var(--radius-md); 
            overflow: visible; 
        }
        #video { 
            width: 100%; 
            height: auto; 
            display: block; 
        }
        #canvas { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            pointer-events: none; 
        }
        .scanner-overlay { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            width: 200px; 
            height: 200px; 
            border: 3px solid var(--primary); 
            border-radius: var(--radius-md); 
            pointer-events: none; 
        }
        .scanner-overlay::before { 
            content: ''; 
            position: absolute; 
            top: -3px; 
            left: -3px; 
            right: -3px; 
            bottom: -3px; 
            border: 2px solid var(--primary); 
            border-radius: var(--radius-md); 
            animation: scanPulse 2s infinite; 
        }
        @keyframes scanPulse { 
            0%, 100% { 
                opacity: 1; 
                transform: scale(1); 
            } 
            50% { 
                opacity: 0.5; 
                transform: scale(1.05); 
            } 
        }
        .controls { 
            display: flex; 
            gap: 10px; 
            justify-content: center; 
            margin: 20px 0; 
            flex-wrap: wrap; 
        }
        .btn { 
            padding: 10px 20px; 
            border: none; 
            border-radius: var(--radius-sm); 
            cursor: pointer; 
            font-size: 1rem; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            transition: all 0.3s ease; 
        }
        .btn-primary { 
            background-color: var(--primary); 
            color: var(--on-primary); 
        }
        .btn-secondary { 
            background-color: var(--secondary); 
            color: var(--on-secondary); 
        }
        .btn-success { 
            background-color: var(--success); 
            color: var(--on-success); 
        }
        .btn-error { 
            background-color: var(--error); 
            color: var(--on-error); 
        }
        .btn:hover { 
            opacity: 0.9; 
            transform: translateY(-2px); 
        }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none; 
        }
        .result-section { 
            margin-top: 20px; 
            padding: 20px; 
            background: var(--surface); 
            border-radius: var(--radius-md); 
            border: 1px solid var(--outline); 
        }
        .result-item { 
            margin-bottom: 15px; 
            padding: 10px; 
            background: var(--surface-variant); 
            border-radius: var(--radius-sm); 
        }
        .result-item h4 { 
            margin-bottom: 5px; 
            color: var(--primary); 
        }
        .result-item p { 
            margin: 5px 0; 
            word-break: break-all; 
        }
        .result-actions { 
            display: flex; 
            gap: 10px; 
            margin-top: 10px; 
            flex-wrap: wrap; 
        }
        .btn-small { 
            padding: 5px 10px; 
            font-size: 0.9rem; 
        }
        .status-indicator { 
            display: inline-block; 
            width: 8px; 
            height: 8px; 
            border-radius: 50%; 
            margin-right: 5px; 
        }
        .status-scanning { 
            background-color: var(--primary); 
            animation: pulse 1s infinite; 
        }
        .status-success { 
            background-color: var(--success); 
        }
        .status-error { 
            background-color: var(--error); 
        }
        .status-stopped { 
            background-color: var(--warning); 
        }
        @keyframes pulse { 
            0%, 100% { 
                opacity: 1; 
            } 
            50% { 
                opacity: 0.5; 
            } 
        }
        .scan-history { 
            max-height: 300px; 
            overflow-y: auto; 
        }
        .history-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px; 
            border-bottom: 1px solid var(--outline); 
        }
        .history-item:last-child { 
            border-bottom: none; 
        }
        .history-content { 
            flex: 1; 
            margin-right: 10px; 
        }
        .history-time { 
            font-size: 0.8rem; 
            color: var(--on-surface-variant); 
        }
        .connection-types { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 10px; 
            margin-top: 20px; 
        }
        .connection-type { 
            padding: 10px; 
            background: var(--surface); 
            border-radius: var(--radius-sm); 
            border: 1px solid var(--outline); 
            text-align: center; 
        }
        .connection-type.active { 
            border-color: var(--primary); 
            background: var(--primary-container); 
        }
    </style>

        <style>
            .navigation-buttons {
                position: fixed;
                bottom: 20px;
                right: 20px;
                display: flex;
                gap: 10px;
                z-index: 1000;
            }
            
            .nav-btn {
                width: 50px;
                height: 50px;
                border-radius: 50%;
                border: none;
                background: var(--primary, #007bff);
                color: white;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                transition: all 0.3s ease;
            }
            
            .nav-btn:hover {
                transform: scale(1.1);
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            }
            
            .nav-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
            }
            
            .nav-btn svg {
                width: 20px;
                height: 20px;
            }
        </style>

    </head>
<body>
    
        <header class="top-app-bar">
            <div class="top-app-bar-content">
                <button class="icon-button" onclick="window.history.back()" title="Zur√ºck" title="Action Button">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                </button>
                <h1 class="top-app-bar-title">Navigation</h1>
                <div class="top-app-bar-actions"><button class="icon-button" onclick="window.history.forward()" title="Vorw√§rts" title="Action Button">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M4 11v2h12.17l-5.59 5.59L12 20l8-8-8-8-1.41 1.41L16.17 11H4z"/></svg>
                    </button>
                    
                    <button class="icon-button" onclick="window.history.forward()" title="Vorw√§rts" title="Action Button">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M4 11v2h12.17l-5.59 5.59L12 20l8-8-8-8-1.41 1.41L16.17 11H4z"/></svg>
                    </button>
                </div>
            </div>
        </header>
        <main class="main-content">

    <div class="scanner-container">
        <h1>üì± QR Code Scanner</h1>
        
        <!-- Scanner Section -->
        <div class="scanner-section">
            <h3>
                <span id="scannerStatus" class="status-indicator status-stopped"></span>
                üì∑ QR-Code Scanner
            </h3>
            
            <div class="video-container">
                <video id="video" autoplay muted playsinline></video>
                <canvas id="canvas"></canvas>
                <div class="scanner-overlay"></div>
            </div>
            
            <div class="controls">
                <button class="btn btn-primary" id="startBtn" onclick="startScanner()" title="Action Button">
                    ‚ñ∂Ô∏è Scanner starten
                </button>
                <button class="btn btn-secondary" id="stopBtn" onclick="stopScanner()" disabled title="Action Button">
                    ‚èπÔ∏è Scanner stoppen
                </button>
                <button class="btn btn-success" onclick="switchCamera()" title="Action Button">
                    üîÑ Kamera wechseln
                </button>
                <button class="btn btn-secondary" onclick="toggleFlash()" title="Action Button">
                    üí° Blitz umschalten
                </button>
            </div>
            
            <div id="scannerInfo" style="text-align: center; margin-top: 10px; color: var(--on-surface-variant);">
                Klicke auf "Scanner starten" um zu beginnen
            </div>
        </div>

        <!-- Connection Types -->
        <div class="scanner-section">
            <h3>üîó Unterst√ºtzte Verbindungstypen</h3>
            <div class="connection-types">
                <div class="connection-type">
                    <h4>üì± App-Links</h4>
                    <p>Direkte App-Verbindungen</p>
                </div>
                <div class="connection-type">
                    <h4>üåê WebRTC</h4>
                    <p>Video-Call-Verbindungen</p>
                </div>
                <div class="connection-type">
                    <h4>üñ•Ô∏è Screen-Share</h4>
                    <p>Bildschirmfreigabe</p>
                </div>
                <div class="connection-type">
                    <h4>üîó Matrix</h4>
                    <p>Matrix-Room-Links</p>
                </div>
                <div class="connection-type">
                    <h4>üì∂ WiFi Direct</h4>
                    <p>WiFi-Direct-Verbindungen</p>
                </div>
                <div class="connection-type">
                    <h4>üîµ Bluetooth</h4>
                    <p>Bluetooth-Verbindungen</p>
                </div>
            </div>
        </div>

        <!-- Scan Results -->
        <div class="scanner-section" id="resultsSection" style="display: block;">
            <h3>‚úÖ Scan-Ergebnisse</h3>
            <div id="scanResults"></div>
        </div>

        <!-- Scan History -->
        <div class="scanner-section">
            <h3>üìú Scan-Verlauf</h3>
            <div class="scan-history" id="scanHistory">
                <p style="text-align: center; color: var(--on-surface-variant);">
                    Noch keine Scans durchgef√ºhrt
                </p>
            </div>
            <div style="text-align: center; margin-top: 10px;">
                <button class="btn btn-secondary btn-small" onclick="clearHistory()" title="Action Button">
                    üóëÔ∏è Verlauf l√∂schen
                </button>
                <button class="btn btn-secondary btn-small" onclick="exportHistory()" title="Action Button">
                    üì§ Verlauf exportieren
                </button>
            </div>
        </div>
    </div>

    <script src="../shared/common-functions.js"></script>
    <script>
        class QRCodeScanner {
            constructor() {
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.isScanning = false;
                this.currentStream = null;
                this.scanHistory = JSON.parse(localStorage.getItem('qrScanHistory') || '[]');
                this.currentCamera = 'environment'; // 'user' for front camera, 'environment' for back camera
                this.flashEnabled = false;
                
                this.init();
            }

            init() {
                this.updateUI();
                this.renderHistory();
                this.setupEventListeners();
            }

            setupEventListeners() {
                // Handle page visibility change
                document.addEventListener('visibilitychange', () => {
                    if (document.visible && this.isScanning) {
                        this.stopScanner();
                    }
                });
            }

            async startScanner() {
                try {
                    this.updateStatus('scanning', 'Scanner wird gestartet...');
                    
                    const constraints = {
                        video: {
                            facingMode: this.currentCamera,
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    };

                    this.currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.video.srcObject = this.currentStream;
                    
                    this.video.onloadedmetadata = () => {
                        this.canvas.width = this.video.videoWidth;
                        this.canvas.height = this.video.videoHeight;
                        this.isScanning = true;
                        this.updateStatus('scanning', 'Scanner l√§uft - QR-Code in den Rahmen halten');
                        this.startScanning();
                    };
                    
                } catch (error) {
                    console.error('Camera access error:', error);
                    this.updateStatus('error', 'Kamera-Zugriff fehlgeschlagen: ' + error.message);
                }
            }

            stopScanner() {
                this.isScanning = false;
                
                if (this.currentStream) {
                    this.currentStream.getTracks().forEach(track => track.stop());
                    this.currentStream = null;
                }
                
                this.video.srcObject = null;
                this.updateStatus('stopped', 'Scanner gestoppt');
                this.updateUI();
            }

            startScanning() {
                if (!this.isScanning) return;
                
                this.scanFrame();
                requestAnimationFrame(() => this.startScanning());
            }

            scanFrame() {
                if (!this.isScanning || this.video.readyState !== this.video.HAVE_ENOUGH_DATA) {
                    return;
                }

                this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
                const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (code) {
                    this.handleQRCode(code.data, code.location);
                }
            }

            handleQRCode(data, location) {
                console.log('QR Code detected:', data);
                this.updateStatus('success', 'QR-Code erkannt!');
                this.stopScanner();
                
                // Add to history
                const scanResult = {
                    data: data,
                    timestamp: new Date().toISOString(),
                    type: this.detectConnectionType(data)
                };
                
                this.scanHistory.unshift(scanResult);
                if (this.scanHistory.length > 50) {
                    this.scanHistory = this.scanHistory.slice(0, 50);
                }
                
                localStorage.setItem('qrScanHistory', JSON.stringify(this.scanHistory));
                this.renderHistory();
                this.displayResult(scanResult);
            }

            detectConnectionType(data) {
                if (data.includes('telco://')) return 'telco-app';
                if (data.includes('webrtc') || data.includes('peerlink')) return 'webrtc';
                if (data.includes('screenshare') || data.includes('conference')) return 'screenshare';
                if (data.includes('matrix.to') || data.includes('matrix://')) return 'matrix';
                if (data.includes('wifi-direct') || data.includes('wifi')) return 'wifi-direct';
                if (data.includes('bluetooth') || data.includes('bt://')) return 'bluetooth';
                if (data.startsWith('http://') || data.startsWith('https://')) return 'web';
                if (data.includes('@') && data.includes('.')) return 'contact';
                return 'unknown';
            }

            displayResult(scanResult) {
                const resultsSection = document.getElementById('resultsSection');
                const scanResults = document.getElementById('scanResults');
                
                const typeInfo = this.getTypeInfo(scanResult.type);
                
                scanResults.innerHTML = `
                    <div class="result-item">
                        <h4>${typeInfo.icon} ${typeInfo.name}</h4>
                        <p><strong>Inhalt:</strong> ${scanResult.data}</p>
                        <p><strong>Typ:</strong> ${typeInfo.description}</p>
                        <p><strong>Zeit:</strong> ${new Date(scanResult.timestamp).toLocaleString()}</p>
                        <div class="result-actions">
                            <button class="btn btn-primary btn-small" onclick="handleConnection('${scanResult.data}', '${scanResult.type}')" title="Action Button">
                                üîó Verbinden
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="copyToClipboard('${scanResult.data}')" title="Action Button">
                                üìã Kopieren
                            </button>
                            <button class="btn btn-success btn-small" onclick="shareResult('${scanResult.data}')" title="Action Button">
                                üì§ Teilen
                            </button>
                        </div>
                    </div>
                `;
                
                resultsSection.style.display = 'block';
            }

            getTypeInfo(type) {
                const typeMap = {
                    'telco-app': { icon: 'üì±', name: 'TELCO App', description: 'App-Verbindung' },
                    'webrtc': { icon: 'üé•', name: 'WebRTC', description: 'Video-Call' },
                    'screenshare': { icon: 'üñ•Ô∏è', name: 'Screen-Share', description: 'Bildschirmfreigabe' },
                    'matrix': { icon: 'üîó', name: 'Matrix', description: 'Matrix-Room' },
                    'wifi-direct': { icon: 'üì∂', name: 'WiFi Direct', description: 'WiFi-Verbindung' },
                    'bluetooth': { icon: 'üîµ', name: 'Bluetooth', description: 'Bluetooth-Verbindung' },
                    'web': { icon: 'üåê', name: 'Web-Link', description: 'Website' },
                    'contact': { icon: 'üë§', name: 'Kontakt', description: 'Kontaktinformationen' },
                    'unknown': { icon: '‚ùì', name: 'Unbekannt', description: 'Unbekannter Typ' }
                };
                
                return typeMap[type] || typeMap['unknown'];
            }

            renderHistory() {
                const historyContainer = document.getElementById('scanHistory');
                
                if (this.scanHistory.length === 0) {
                    historyContainer.innerHTML = '<p style="text-align: center; color: var(--on-surface-variant);">Noch keine Scans durchgef√ºhrt</p>';
                    return;
                }
                
                historyContainer.innerHTML = this.scanHistory.map(scan => {
                    const typeInfo = this.getTypeInfo(scan.type);
                    const time = new Date(scan.timestamp).toLocaleString();
                    
                    return `
                        <div class="history-item">
                            <div class="history-content">
                                <div>${typeInfo.icon} ${typeInfo.name}</div>
                                <div style="font-size: 0.9rem; color: var(--on-surface-variant); word-break: break-all;">
                                    ${scan.data}
                                </div>
                                <div class="history-time">${time}</div>
                            </div>
                            <button class="btn btn-secondary btn-small" onclick="handleConnection('${scan.data}', '${scan.type}')" title="Action Button">
                                üîó
                            </button>
                        </div>
                    `;
                }).join('');
            }

            updateStatus(status, message) {
                // Verwende globale Status-Hilfsfunktion
                TelcoCommon.updateStatus('scannerStatus', status, message);
                const scannerInfo = document.getElementById('scannerInfo');
                if (scannerInfo) scannerInfo.textContent = message;
                this.updateUI();
            }

            updateUI() {
                const startBtn = document.getElementById('startBtn');
                const stopBtn = document.getElementById('stopBtn');
                
                if (startBtn) {
                    startBtn.disabled = this.isScanning;
                    startBtn.innerHTML = this.isScanning ? '‚è≥ Scanne...' : '‚ñ∂ Start';
                }
                if (stopBtn) {
                    stopBtn.disabled = !this.isScanning;
                }
            }

            clearHistory() {
                if (confirm('Scan-Verlauf wirklich l√∂schen?')) {
                    this.scanHistory = [];
                    localStorage.removeItem('qrScanHistory');
                    this.renderHistory();
                }
            }

            exportHistory() {
                // Verwende globale Export-Hilfsfunktion
                TelcoCommon.exportData(this.scanHistory, 'qr-scan-history');
            }
        }

        // Global functions
        function startScanner() {
            window.qrScanner.startScanner();
        }

        function stopScanner() {
            window.qrScanner.stopScanner();
        }

        function switchCamera() {
            window.qrScanner.currentCamera = window.qrScanner.currentCamera === 'environment' ? 'user' : 'environment';
            if (window.qrScanner.isScanning) {
                window.qrScanner.stopScanner();
                setTimeout(() => window.qrScanner.startScanner(), 500);
            }
        }

        function toggleFlash() {
            // Flash toggle implementation would go here
            alert('Flash-Funktion wird implementiert...');
        }

        function handleConnection(data, type) {
            console.log('Handling connection:', data, type);
            
            switch(type) {
                case 'telco-app':
                case 'webrtc':
                case 'screenshare':
                    window.location.href = data;
                    break;
                case 'matrix':
                    window.open(data, '_blank');
                    break;
                case 'wifi-direct':
                case 'bluetooth':
                    alert(`${type} Verbindung wird implementiert...`);
                    break;
                case 'web':
                    window.open(data, '_blank');
                    break;
                case 'contact':
                    // Handle contact info
                    alert('Kontakt wird zu den Kontakten hinzugef√ºgt...');
                    break;
                default:
                    alert(`Verbindungstyp "${type}" wird unterst√ºtzt: ${data}`);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('In Zwischenablage kopiert!');
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('Kopieren fehlgeschlagen');
            });
        }

        function shareResult(data) {
            if (navigator.share) {
                navigator.share({
                    title: 'QR-Code Inhalt',
                    text: data
                }).catch(err => console.log('Share cancelled:', err));
            } else {
                copyToClipboard(data);
            }
        }

        function clearHistory() {
            window.qrScanner.clearHistory();
        }

        function exportHistory() {
            window.qrScanner.exportHistory();
        }

        // Initialize scanner when page loads
        window.addEventListener('DOMContentLoaded', () => {
            window.qrScanner = new QRCodeScanner();
        });
    </script>
        </main>
    
        <script>
            // Browser Navigation Enhancement
            document.addEventListener('DOMContentLoaded', function() {
                // Navigation-Status anzeigen
                updateNavigationStatus();
                
                // Popstate Event f√ºr Browser-Navigation
                window.addEventListener('popstate', function(event) {
                    console.log('Browser Navigation:', event.state);
                    updateNavigationStatus();
                });
                
                // Navigation-Status aktualisieren
                function updateNavigationStatus() {
                    const canGoBack = window.history.length > 1;
                    const canGoForward = window.history.length > 1; // Vereinfacht
                    
                    // Back-Button aktivieren/deaktivieren
                    const backButtons = document.querySelectorAll('button[onclick*="history.back"]');
                    backButtons.forEach(btn => {
                        btn.disabled = !canGoBack;
                        btn.style.opacity = canGoBack ? '1' : '0.5';
                    });
                    
                    // Forward-Button aktivieren/deaktivieren
                    const forwardButtons = document.querySelectorAll('button[onclick*="history.forward"]');
                    forwardButtons.forEach(btn => {
                        btn.disabled = !canGoForward;
                        btn.style.opacity = canGoForward ? '1' : '0.5';
                    });
                }
                
                // Globale Navigation-Funktionen
                window.goBack = function() {
                    if (window.history.length > 1) {
                        window.history.back();
                    }
                };
                
                window.goForward = function() {
                    window.history.forward();
                };
                
                window.goHome = function() {
                    window.location.href = '/';
                };
            });
        </script>

    </body>
</html>
