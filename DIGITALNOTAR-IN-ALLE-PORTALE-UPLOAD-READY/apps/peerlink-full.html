<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PeerLink Voll</title>
<h1 style="position: absolute; left: -9999px;">PeerLink Voll</h1>
  <link rel="stylesheet" href="../styles.css">
  <style>
    .layout{display:grid; gap:var(--spacing-lg); grid-template-columns:2fr 1fr}
    .card{background:var(--surface); border:1px solid var(--outline); border-radius:var(--radius-lg); padding:var(--spacing-lg)}
    video{width:100%; aspect-ratio:16/9; background:#000; border-radius:var(--radius-md)}
    .controls{display:flex; gap:var(--spacing-sm); flex-wrap:wrap; margin-bottom:var(--spacing-md)}
    input,button,textarea{padding:.6rem .9rem; border-radius:var(--radius-sm); border:1px solid var(--outline); background:var(--surface); color:var(--on-surface)}
    button{cursor:pointer}
    #chat{height:260px; overflow:auto; border:1px solid var(--outline); border-radius:var(--radius-sm); padding:.5rem; margin-bottom:.5rem}
    #qr{width:100%; height:auto}
    @media (max-width: 980px){ .layout{grid-template-columns:1fr} }
  </style>

        <style>
            .navigation-buttons {
                position: fixed;
                bottom: 20px;
                right: 20px;
                display: flex;
                gap: 10px;
                z-index: 1000;
            }
            
            .nav-btn {
                width: 50px;
                height: 50px;
                border-radius: 50%;
                border: none;
                background: var(--primary, #007bff);
                color: white;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                transition: all 0.3s ease;
            }
            
            .nav-btn:hover {
                transform: scale(1.1);
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            }
            
            .nav-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
            }
            
            .nav-btn svg {
                width: 20px;
                height: 20px;
            }
        </style>

    </head>
<body>
    
        <header class="top-app-bar">
            <div class="top-app-bar-content">
                <button class="icon-button" onclick="window.history.back()" title="Zurück" title="Action Button">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                </button>
                <h1 class="top-app-bar-title">Navigation</h1>
                <div class="top-app-bar-actions"><button class="icon-button" onclick="window.history.forward()" title="Vorwärts" title="Action Button">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M4 11v2h12.17l-5.59 5.59L12 20l8-8-8-8-1.41 1.41L16.17 11H4z"/></svg>
                    </button>
                    
                    <button class="icon-button" onclick="window.history.forward()" title="Vorwärts" title="Action Button">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M4 11v2h12.17l-5.59 5.59L12 20l8-8-8-8-1.41 1.41L16.17 11H4z"/></svg>
                    </button>
                </div>
            </div>
        </header>
        <main class="main-content">

  <div class="main-content">
    <div class="layout">
      <div class="card">
        <div class="controls">
          <input id="room" placeholder="Raum-ID" aria-label="Input Field">
          <button id="join" title="Action Button">Beitreten</button>
          <button id="leave" disabled title="Action Button">Verlassen</button>
          <button id="share" disabled title="Action Button">Bildschirm teilen</button>
          <span class="badge" id="status">getrennt</span>
        </div>
        <video id="local" autoplay playsinline muted></video>
        <video id="remote" autoplay playsinline></video>
      </div>
      <div class="card">
        <h3>Chat & Einladen</h3>
        <div id="chat"></div>
        <div class="controls">
          <input id="msg" placeholder="Nachricht" aria-label="Input Field">
          <button id="send" disabled title="Action Button">Senden</button>
        </div>
        <canvas id="qr"></canvas>
        <small>Teile den QR‑Code, um dem Raum beizutreten.</small>
      </div>
    </div>
  </div>

  <script>
    const wsURL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.hostname + (location.port ? ':'+location.port : '') + '/';
    let pc, ws, roomId, localStream, dc;
    const el = id => document.getElementById(id);
    const setStatus = (t)=> el('status').textContent = t;

    async function openMedia(){
      if (localStream) return localStream;
      localStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:true });
      el('local').srcObject = localStream;
      return localStream;
    }
    function qrcode(text){
      const c = el('qr'), ctx = c.getContext('2d');
      // tiny QR: draw simple placeholder if lib not available
      c.width = c.height = 220;
      ctx.fillStyle = '#fff'; ctx.fillRect(0,0,220,220);
      ctx.fillStyle = '#000';
      // hash-based pattern
      let h = 0; for (let i=0;i<text.length;i++) h = (h*33 ^ text.charCodeAt(i)) >>> 0;
      for (let y=0;y<21;y++) for(let x=0;x<21;x++){
        const bit = (h >> ((x*y + y) % 31)) & 1;
        if ((x<7 && y<7) || (x>13 && y<7) || (x<7 && y>13)) { // finders
          if ( (x%6 && y%6) ) ctx.fillRect(x*10,y*10,10,10);
        } else if (bit){ ctx.fillRect(x*10,y*10,10,10); }
      }
    }

    function connectWS(){
      return new Promise((resolve, reject) => {
        ws = new WebSocket(wsURL);
        ws.onopen = resolve;
        ws.onerror = reject;
        ws.onmessage = async (ev) => {
          const msg = JSON.parse(ev.data||'{}');
          if (msg.type === 'signal'){ await handleSignal(msg.payload || {}); }
          if (msg.type === 'peer-joined'){ if (pc) makeOffer(); appendChat('System: Peer beigetreten'); }
          if (msg.type === 'peer-left'){ appendChat('System: Peer hat verlassen'); setStatus('wartet auf Peer'); }
          if (msg.type === 'joined'){ setStatus('verbunden'); }
        };
        ws.onclose = () => setStatus('getrennt');
      });
    }

    function createPeer(){
      pc = new RTCPeerConnection({ iceServers: [{ urls:'stun:stun.l.google.com:19302' }] });
      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
      pc.ontrack = (e) => { document.getElementById('remote').srcObject = e.streams[0]; };
      pc.onicecandidate = (e) => { if (e.candidate) ws?.send(JSON.stringify({ type:'signal', room:roomId, payload:{ candidate:e.candidate } })); };
      // DataChannel for chat
      dc = pc.createDataChannel('chat');
      dc.onopen = () => { el('send').disabled = false; };
      dc.onmessage = (e) => appendChat('Peer: ' + e.data);
      pc.ondatachannel = (e) => {
        dc = e.channel;
        dc.onmessage = (e) => appendChat('Peer: ' + e.data);
        dc.onopen = () => { el('send').disabled = false; };
      };
    }

    async function makeOffer(){
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      ws?.send(JSON.stringify({ type:'signal', room:roomId, payload:{ sdp: pc.localDescription } }));
    }
    async function handleSignal({ sdp, candidate }){
      if (sdp){
        await pc.setRemoteDescription(new RTCSessionDescription(sdp));
        if (sdp.type === 'offer'){
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          ws?.send(JSON.stringify({ type:'signal', room:roomId, payload:{ sdp: pc.localDescription } }));
        }
      } else if (candidate){
        try { await pc.addIceCandidate(new RTCIceCandidate(candidate)); } catch {}
      }
    }

    function appendChat(line){
      const div = el('chat');
      const p = document.createElement('div');
      p.textContent = `[${new Date().toLocaleTimeString()}] ${line}`;
      div.appendChild(p);
      div.scrollTop = div.scrollHeight;
    }
    function sendMsg(){
      const v = el('msg').value.trim();
      if (!v || !dc || dc.readyState!=='open') return;
      dc.send(v);
      appendChat('Ich: ' + v);
      el('msg').value='';
    }
    async function shareScreen(){
      const stream = await navigator.mediaDevices.getDisplayMedia({ video:true, audio:true });
      const track = stream.getVideoTracks()[0];
      const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
      if (sender) sender.replaceTrack(track);
      track.onended = async () => {
        const camTrack = (await navigator.mediaDevices.getUserMedia({video:true})).getVideoTracks()[0];
        const s = pc.getSenders().find(s => s.track && s.track.kind === 'video');
        if (s) s.replaceTrack(camTrack);
      };
    }

    async function join(){
      roomId = (el('room').value||'').trim();
      if (!roomId) { alert('Bitte Raum-ID angeben'); return; }
      location.hash = '#'+encodeURIComponent(roomId);
      qrcode(location.href);
      await openMedia();
      await connectWS();
      createPeer();
      ws.send(JSON.stringify({ type:'join', room:roomId }));
      el('leave').disabled = false;
      el('share').disabled = false;
    }
    function leave(){
      if (ws) ws.send(JSON.stringify({ type:'leave' }));
      if (pc) pc.close();
      setStatus('getrennt'); el('leave').disabled = el('share').disabled = el('send').disabled = true;
    }

    el('join').onclick = join;
    el('leave').onclick = leave;
    el('share').onclick = shareScreen;
    el('send').onclick = sendMsg;
    el('msg').addEventListener('keydown', e => (e.key==='Enter') && sendMsg());

    // Autofill room from hash
    if (location.hash.length>1){ el('room').value = decodeURIComponent(location.hash.slice(1)); }
  </script>
        </main>
    
        <script>
            // Browser Navigation Enhancement
            document.addEventListener('DOMContentLoaded', function() {
                // Navigation-Status anzeigen
                updateNavigationStatus();
                
                // Popstate Event für Browser-Navigation
                window.addEventListener('popstate', function(event) {
                    console.log('Browser Navigation:', event.state);
                    updateNavigationStatus();
                });
                
                // Navigation-Status aktualisieren
                function updateNavigationStatus() {
                    const canGoBack = window.history.length > 1;
                    const canGoForward = window.history.length > 1; // Vereinfacht
                    
                    // Back-Button aktivieren/deaktivieren
                    const backButtons = document.querySelectorAll('button[onclick*="history.back"]');
                    backButtons.forEach(btn => {
                        btn.disabled = !canGoBack;
                        btn.style.opacity = canGoBack ? '1' : '0.5';
                    });
                    
                    // Forward-Button aktivieren/deaktivieren
                    const forwardButtons = document.querySelectorAll('button[onclick*="history.forward"]');
                    forwardButtons.forEach(btn => {
                        btn.disabled = !canGoForward;
                        btn.style.opacity = canGoForward ? '1' : '0.5';
                    });
                }
                
                // Globale Navigation-Funktionen
                window.goBack = function() {
                    if (window.history.length > 1) {
                        window.history.back();
                    }
                };
                
                window.goForward = function() {
                    window.history.forward();
                };
                
                window.goHome = function() {
                    window.location.href = '/';
                };
            });
        </script>

    </body>
</html>
