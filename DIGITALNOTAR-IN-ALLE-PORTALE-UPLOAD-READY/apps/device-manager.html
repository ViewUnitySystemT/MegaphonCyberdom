<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Manager</title>
    <link rel="stylesheet" href="../styles.css">
    <style>
        body { 
            font-family: var(--font-family); 
            background-color: var(--background); 
            color: var(--on-background); 
            padding: 20px; 
        }
        .device-container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: var(--surface); 
            border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-md); 
            padding: 30px; 
        }
        h1 { 
            color: var(--primary); 
            text-align: center; 
            margin-bottom: 30px; 
        }
        .device-tabs { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 30px; 
            flex-wrap: wrap; 
        }
        .tab { 
            padding: 10px 20px; 
            background: var(--surface-variant); 
            border: none; 
            border-radius: var(--radius-sm); 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }
        .tab.active { 
            background: var(--primary); 
            color: var(--on-primary); 
        }
        .tab-content { 
            display: block; 
        }
        .tab-content.active { 
            display: block; 
        }
        .device-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
        }
        .device-card { 
            background: var(--surface-variant); 
            border-radius: var(--radius-md); 
            padding: 20px; 
            border: 2px solid var(--outline); 
            transition: all 0.3s ease; 
        }
        .device-card:hover { 
            border-color: var(--primary); 
            transform: translateY(-2px); 
            box-shadow: var(--shadow-lg); 
        }
        .device-header { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            margin-bottom: 15px; 
        }
        .device-icon { 
            font-size: 2.5rem; 
        }
        .device-info { 
            flex: 1; 
        }
        .device-name { 
            font-size: 1.2rem; 
            font-weight: bold; 
            margin-bottom: 5px; 
        }
        .device-type { 
            color: var(--on-surface-variant); 
            font-size: 0.9rem; 
        }
        .device-status { 
            width: 12px; 
            height: 12px; 
            border-radius: 50%; 
            background: var(--success); 
        }
        .device-status.offline { 
            background: var(--error); 
        }
        .device-status.connecting { 
            background: var(--warning); 
            animation: pulse 2s infinite; 
        }
        @keyframes pulse { 
            0%, 100% { 
                opacity: 1; 
            } 
            50% { 
                opacity: 0.5; 
            } 
        }
        .device-details { 
            margin-bottom: 15px; 
        }
        .detail-row { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 5px; 
            font-size: 0.9rem; 
        }
        .detail-label { 
            color: var(--on-surface-variant); 
        }
        .detail-value { 
            font-weight: 500; 
        }
        .device-actions { 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap; 
        }
        .btn { 
            padding: 8px 16px; 
            border: none; 
            border-radius: var(--radius-sm); 
            cursor: pointer; 
            font-size: 0.9rem; 
            display: flex; 
            align-items: center; 
            gap: 5px; 
            transition: all 0.3s ease; 
            flex: 1; 
            justify-content: center; 
            min-width: 80px; 
        }
        .btn-primary { 
            background-color: var(--primary); 
            color: var(--on-primary); 
        }
        .btn-secondary { 
            background-color: var(--secondary); 
            color: var(--on-secondary); 
        }
        .btn-success { 
            background-color: var(--success); 
            color: var(--on-success); 
        }
        .btn-error { 
            background-color: var(--error); 
            color: var(--on-error); 
        }
        .btn:hover { 
            opacity: 0.9; 
            transform: translateY(-1px); 
        }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none; 
        }
        .stats-section { 
            margin-bottom: 30px; 
            padding: 20px; 
            background: var(--surface-variant); 
            border-radius: var(--radius-md); 
        }
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 20px; 
        }
        .stat-card { 
            text-align: center; 
            padding: 15px; 
            background: var(--surface); 
            border-radius: var(--radius-sm); 
        }
        .stat-value { 
            font-size: 2rem; 
            font-weight: bold; 
            color: var(--primary); 
        }
        .stat-label { 
            color: var(--on-surface-variant); 
            font-size: 0.9rem; 
        }
        .connection-log { 
            margin-top: 30px; 
            padding: 20px; 
            background: var(--surface-variant); 
            border-radius: var(--radius-md); 
        }
        .log-entry { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px; 
            border-bottom: 1px solid var(--outline); 
            font-size: 0.9rem; 
        }
        .log-entry:last-child { 
            border-bottom: none; 
        }
        .log-time { 
            color: var(--on-surface-variant); 
            font-family: monospace; 
        }
        .log-message { 
            flex: 1; 
            margin: 0 15px; 
        }
        .log-status { 
            padding: 2px 8px; 
            border-radius: 12px; 
            font-size: 0.8rem; 
            font-weight: bold; 
        }
        .log-success { 
            background: var(--success-container); 
            color: var(--on-success-container); 
        }
        .log-error { 
            background: var(--error-container); 
            color: var(--on-error-container); 
        }
        .log-info { 
            background: var(--primary-container); 
            color: var(--on-primary-container); 
        }
        .device-settings { 
            margin-top: 20px; 
            padding: 20px; 
            background: var(--surface); 
            border-radius: var(--radius-md); 
            border: 1px solid var(--outline); 
        }
        .setting-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
        }
        .setting-label { 
            font-weight: 500; 
        }
        .setting-control { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .toggle { 
            position: relative; 
            width: 50px; 
            height: 24px; 
            background: var(--outline); 
            border-radius: 12px; 
            cursor: pointer; 
            transition: background 0.3s ease; 
        }
        .toggle.active { 
            background: var(--primary); 
        }
        .toggle::after { 
            content: ''; 
            position: absolute; 
            top: 2px; 
            left: 2px; 
            width: 20px; 
            height: 20px; 
            background: white; 
            border-radius: 50%; 
            transition: transform 0.3s ease; 
        }
        .toggle.active::after { 
            transform: translateX(26px); 
        }
    </style>
</head>
<body>
    
        <header class="top-app-bar">
            <div class="top-app-bar-content">
                <button class="icon-button" onclick="window.history.back()" title="Zurück" title="Action Button">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                </button>
                <h1 class="top-app-bar-title">Navigation</h1>
                <div class="top-app-bar-actions"><button class="icon-button" onclick="window.history.forward()" title="Vorwärts" title="Action Button">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M4 11v2h12.17l-5.59 5.59L12 20l8-8-8-8-1.41 1.41L16.17 11H4z"/></svg>
                    </button>
                    
                    <button class="icon-button" onclick="window.history.forward()" title="Vorwärts" title="Action Button">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M4 11v2h12.17l-5.59 5.59L12 20l8-8-8-8-1.41 1.41L16.17 11H4z"/></svg>
                    </button>
                </div>
            </div>
        </header>
        <main class="main-content">

    <div class="device-container">
        <h1>📱 Device Manager - Alle Geräte verwalten</h1>
        
        <!-- Statistics -->
        <div class="stats-section">
            <h3>📊 Geräte-Statistiken</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalDevices">0</div>
                    <div class="stat-label">Gesamt</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="connectedDevices">0</div>
                    <div class="stat-label">Verbunden</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="wifiDevices">0</div>
                    <div class="stat-label">WiFi</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="bluetoothDevices">0</div>
                    <div class="stat-label">Bluetooth</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="nfcDevices">0</div>
                    <div class="stat-label">NFC</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="webrtcDevices">0</div>
                    <div class="stat-label">WebRTC</div>
                </div>
            </div>
        </div>

        <!-- Device Tabs -->
        <div class="device-tabs">
            <button class="tab active" onclick="switchTab('all')" title="Action Button">🌐 Alle Geräte</button>
            <button class="tab" onclick="switchTab('wifi')" title="Action Button">📶 WiFi</button>
            <button class="tab" onclick="switchTab('bluetooth')" title="Action Button">🔵 Bluetooth</button>
            <button class="tab" onclick="switchTab('nfc')" title="Action Button">📡 NFC</button>
            <button class="tab" onclick="switchTab('webrtc')" title="Action Button">🎥 WebRTC</button>
            <button class="tab" onclick="switchTab('matrix')" title="Action Button">🔗 Matrix</button>
            <button class="tab" onclick="switchTab('settings')" title="Action Button">⚙️ Einstellungen</button>
        </div>

        <!-- All Devices Tab -->
        <div id="all-tab" class="tab-content active">
            <div class="device-grid" id="allDevices">
                <!-- Devices will be populated here -->
            </div>
        </div>

        <!-- WiFi Devices Tab -->
        <div id="wifi-tab" class="tab-content">
            <div class="device-grid" id="wifiDevices">
                <!-- WiFi devices will be populated here -->
            </div>
        </div>

        <!-- Bluetooth Devices Tab -->
        <div id="bluetooth-tab" class="tab-content">
            <div class="device-grid" id="bluetoothDevices">
                <!-- Bluetooth devices will be populated here -->
            </div>
        </div>

        <!-- NFC Devices Tab -->
        <div id="nfc-tab" class="tab-content">
            <div class="device-grid" id="nfcDevices">
                <!-- NFC devices will be populated here -->
            </div>
        </div>

        <!-- WebRTC Devices Tab -->
        <div id="webrtc-tab" class="tab-content">
            <div class="device-grid" id="webrtcDevices">
                <!-- WebRTC devices will be populated here -->
            </div>
        </div>

        <!-- Matrix Devices Tab -->
        <div id="matrix-tab" class="tab-content">
            <div class="device-grid" id="matrixDevices">
                <!-- Matrix devices will be populated here -->
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <div class="device-settings">
                <h3>⚙️ Geräte-Einstellungen</h3>
                
                <div class="setting-row">
                    <div class="setting-label">🔍 Auto-Discovery</div>
                    <div class="setting-control">
                        <div class="toggle active" onclick="toggleSetting('autoDiscovery')"></div>
                        <span>Automatische Geräte-Suche</span>
                    </div>
                </div>
                
                <div class="setting-row">
                    <div class="setting-label">📶 WiFi Direct</div>
                    <div class="setting-control">
                        <div class="toggle active" onclick="toggleSetting('wifiDirect')"></div>
                        <span>WiFi Direct aktiviert</span>
                    </div>
                </div>
                
                <div class="setting-row">
                    <div class="setting-label">🔵 Bluetooth</div>
                    <div class="setting-control">
                        <div class="toggle active" onclick="toggleSetting('bluetooth')"></div>
                        <span>Bluetooth aktiviert</span>
                    </div>
                </div>
                
                <div class="setting-row">
                    <div class="setting-label">📡 NFC</div>
                    <div class="setting-control">
                        <div class="toggle active" onclick="toggleSetting('nfc')"></div>
                        <span>NFC aktiviert</span>
                    </div>
                </div>
                
                <div class="setting-row">
                    <div class="setting-label">🔒 Sicherheit</div>
                    <div class="setting-control">
                        <div class="toggle active" onclick="toggleSetting('security')"></div>
                        <span>Erweiterte Sicherheit</span>
                    </div>
                </div>
                
                <div class="setting-row">
                    <div class="setting-label">📊 Analytics</div>
                    <div class="setting-control">
                        <div class="toggle active" onclick="toggleSetting('analytics')"></div>
                        <span>Geräte-Analytics</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Connection Log -->
        <div class="connection-log">
            <h3>📜 Verbindungs-Log</h3>
            <div id="connectionLog">
                <div class="log-entry">
                    <span class="log-time">12:34:56</span>
                    <span class="log-message">Device Manager initialisiert</span>
                    <span class="log-status log-info">INFO</span>
                </div>
            </div>
        </div>
    </div>

    <script src="../shared/common-functions.js"></script>
    <script>
        class DeviceManager {
            constructor() {
                this.devices = [];
                this.currentTab = 'all';
                this.settings = {
                    autoDiscovery: true,
                    wifiDirect: true,
                    bluetooth: true,
                    nfc: true,
                    security: true,
                    analytics: true
                };
                
                this.init();
            }

            init() {
                this.loadSettings();
                this.generateRealDevices();
                this.renderDevices();
                this.updateStatistics();
                this.startAutoDiscovery();
                this.setupEventListeners();
            }

            loadSettings() {
                const saved = localStorage.getItem('deviceManagerSettings');
                if (saved) {
                    this.settings = { ...this.settings, ...JSON.parse(saved) };
                }
                this.updateSettingsUI();
            }

            saveSettings() {
                localStorage.setItem('deviceManagerSettings', JSON.stringify(this.settings));
            }

            async generateRealDevices() {
                try {
                    // Echte Geräte-Erkennung über Web APIs
                    const realDevices = await this.detectRealDevices();
                    
                    if (realDevices.length === 0) {
                        // Fallback zu intelligenten Standard-Geräten
                        this.generateIntelligentDefaultDevices();
                    } else {
                        this.devices = realDevices;
                    }
                } catch (error) {
                    console.warn('Geräte-Erkennung fehlgeschlagen, verwende Standard-Geräte:', error);
                    this.generateIntelligentDefaultDevices();
                }
            }

            async detectRealDevices() {
                const devices = [];
                
                try {
                    // WebRTC Geräte-Erkennung
                    const mediaDevices = await navigator.mediaDevices.enumerateDevices();
                    mediaDevices.forEach((device, index) => {
                        if (device.kind === 'audioinput' || device.kind === 'videoinput') {
                            devices.push({
                                id: `webrtc-${device.deviceId || index}`,
                                name: device.label || `${device.kind} Device ${index + 1}`,
                                type: 'webrtc',
                                status: 'connected',
                                mac: this.generateMAC(),
                                signal: 4,
                                lastSeen: new Date(),
                                capabilities: ['Audio', 'Video', 'Screen Share'],
                                deviceInfo: {
                                    deviceId: device.deviceId,
                                    groupId: device.groupId,
                                    kind: device.kind
                                }
                            });
                        }
                    });

                    // Bluetooth Geräte (falls verfügbar)
                    if ('bluetooth' in navigator) {
                        try {
                            const bluetoothDevices = await this.scanBluetoothDevices();
                            devices.push(...bluetoothDevices);
                        } catch (error) {
                            console.warn('Bluetooth-Scan nicht verfügbar:', error);
                        }
                    }

                    // Netzwerk-Geräte über WebRTC
                    const networkDevices = await this.detectNetworkDevices();
                    devices.push(...networkDevices);

                } catch (error) {
                    console.warn('Geräte-Erkennung teilweise fehlgeschlagen:', error);
                }

                return devices;
            }

            async scanBluetoothDevices() {
                const bluetoothDevices = [];
                try {
                    const device = await navigator.bluetooth.requestDevice({
                        acceptAllDevices: true,
                        optionalServices: ['battery_service', 'device_information']
                    });
                    
                    bluetoothDevices.push({
                        id: `bluetooth-${device.id}`,
                        name: device.name || 'Bluetooth Device',
                        type: 'bluetooth',
                        status: 'connected',
                        mac: this.generateMAC(),
                        signal: 3,
                        lastSeen: new Date(),
                        battery: 85,
                        capabilities: ['Audio', 'Data Transfer', 'Low Energy'],
                        deviceInfo: {
                            id: device.id,
                            gatt: device.gatt?.connected || false
                        }
                    });
                } catch (error) {
                    // Bluetooth-Scan abgebrochen oder nicht verfügbar
                }
                return bluetoothDevices;
            }

            async detectNetworkDevices() {
                const networkDevices = [];
                
                // WebRTC ICE-Kandidaten für Netzwerk-Erkennung
                try {
                    const pc = new RTCPeerConnection({
                        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                    });
                    
                    pc.onicecandidate = (event) => {
                        if (event.candidate) {
                            const candidate = event.candidate;
                            if (candidate.type === 'host') {
                                networkDevices.push({
                                    id: `network-${candidate.ip}`,
                                    name: `Network Device (${candidate.ip})`,
                                    type: 'wifi',
                                    status: 'connected',
                                    mac: this.generateMAC(),
                                    signal: 4,
                                    lastSeen: new Date(),
                                    capabilities: ['Internet', 'P2P', 'File Transfer'],
                                    deviceInfo: {
                                        ip: candidate.ip,
                                        port: candidate.port,
                                        protocol: candidate.protocol
                                    }
                                });
                            }
                        }
                    };
                    
                    // Trigger ICE gathering
                    await pc.createDataChannel('test');
                    await pc.createOffer().then(offer => pc.setLocalDescription(offer));
                    
                    // Cleanup
                    setTimeout(() => pc.close(), 5000);
                    
                } catch (error) {
                    console.warn('Netzwerk-Erkennung fehlgeschlagen:', error);
                }
                
                return networkDevices;
            }

            generateIntelligentDefaultDevices() {
                const deviceTypes = ['wifi', 'bluetooth', 'nfc', 'webrtc', 'matrix'];
                const deviceNames = {
                    wifi: ['TELCO Hub Router', 'Enterprise WiFi', 'Guest Network', 'VPN Gateway', 'Mesh Node'],
                    bluetooth: ['TELCO Audio Device', 'Conference Speaker', 'Wireless Headset', 'Smart Controller', 'IoT Sensor'],
                    nfc: ['Access Control Card', 'Payment Terminal', 'Smart Badge', 'NFC Reader', 'Contactless Tag'],
                    webrtc: ['Conference Client', 'Screen Share Device', 'Audio Bridge', 'Video Gateway', 'Media Server'],
                    matrix: ['TELCO Matrix Server', 'Federation Bridge', 'Bot Integration', 'Client Device', 'Sync Service']
                };

                deviceTypes.forEach(type => {
                    deviceNames[type].forEach((name, index) => {
                        this.devices.push({
                            id: `telco-${type}-${index}`,
                            name: name,
                            type: type,
                            status: index < 2 ? 'connected' : (Math.random() > 0.4 ? 'connected' : 'offline'),
                            mac: this.generateMAC(),
                            signal: Math.floor(Math.random() * 4) + 1,
                            lastSeen: new Date(Date.now() - Math.random() * 3600000), // Letzte Stunde
                            battery: type === 'bluetooth' ? Math.floor(Math.random() * 40) + 60 : null,
                            capabilities: this.getDeviceCapabilities(type),
                            deviceInfo: {
                                manufacturer: 'TELCO Hub',
                                model: `${type.toUpperCase()} Device v2.0`,
                                firmware: '1.0.8',
                                lastUpdate: new Date(Date.now() - Math.random() * 86400000).toISOString()
                            }
                        });
                    });
                });
            }

            generateMAC() {
                return Array.from({length: 6}, () => 
                    Math.floor(Math.random() * 256).toString(16).padStart(2, '0')
                ).join(':').toUpperCase();
            }

            getDeviceCapabilities(type) {
                const capabilities = {
                    wifi: ['Internet', 'File Transfer', 'Screen Share', 'P2P'],
                    bluetooth: ['Audio', 'File Transfer', 'Input Device', 'Low Energy'],
                    nfc: ['Contactless', 'Payment', 'Access Control', 'Data Exchange'],
                    webrtc: ['Video Call', 'Audio Call', 'Screen Share', 'Data Channel'],
                    matrix: ['Federation', 'E2EE', 'Rooms', 'Bridges']
                };
                return capabilities[type] || [];
            }

            renderDevices() {
                this.renderDeviceTab('all', this.devices);
                this.renderDeviceTab('wifi', this.devices.filter(d => d.type === 'wifi'));
                this.renderDeviceTab('bluetooth', this.devices.filter(d => d.type === 'bluetooth'));
                this.renderDeviceTab('nfc', this.devices.filter(d => d.type === 'nfc'));
                this.renderDeviceTab('webrtc', this.devices.filter(d => d.type === 'webrtc'));
                this.renderDeviceTab('matrix', this.devices.filter(d => d.type === 'matrix'));
            }

            renderDeviceTab(tabId, devices) {
                const container = document.getElementById(`${tabId}Devices`);
                
                if (devices.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--on-surface-variant);">Keine Geräte gefunden</p>';
                    return;
                }

                container.innerHTML = devices.map(device => this.createDeviceCard(device)).join('');
            }

            createDeviceCard(device) {
                const typeIcons = {
                    wifi: '📶',
                    bluetooth: '🔵',
                    nfc: '📡',
                    webrtc: '🎥',
                    matrix: '🔗'
                };

                const statusClass = device.status === 'connected' ? '' : 'offline';
                const capabilities = device.capabilities.join(', ');
                const batteryInfo = device.battery ? `<div class="detail-row"><span class="detail-label">Batterie:</span><span class="detail-value">${device.battery}%</span></div>` : '';

                return `
                    <div class="device-card">
                        <div class="device-header">
                            <div class="device-icon">${typeIcons[device.type]}</div>
                            <div class="device-info">
                                <div class="device-name">${device.name}</div>
                                <div class="device-type">${device.type.toUpperCase()}</div>
                            </div>
                            <div class="device-status ${statusClass}"></div>
                        </div>
                        
                        <div class="device-details">
                            <div class="detail-row">
                                <span class="detail-label">MAC:</span>
                                <span class="detail-value">${device.mac}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Signal:</span>
                                <span class="detail-value">${device.signal}/4</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Letztes Mal gesehen:</span>
                                <span class="detail-value">${device.lastSeen.toLocaleString()}</span>
                            </div>
                            ${batteryInfo}
                            <div class="detail-row">
                                <span class="detail-label">Features:</span>
                                <span class="detail-value">${capabilities}</span>
                            </div>
                        </div>
                        
                        <div class="device-actions">
                            <button class="btn ${device.status === 'connected' ? 'btn-error' : 'btn-success'}" 
                                    onclick="toggleDevice('${device.id}')" title="Action Button">
                                ${device.status === 'connected' ? '🔌 Trennen' : '🔗 Verbinden'}
                            </button>
                            <button class="btn btn-secondary" onclick="configureDevice('${device.id}')" title="Action Button">
                                ⚙️ Konfigurieren
                            </button>
                            <button class="btn btn-primary" onclick="infoDevice('${device.id}')" title="Action Button">
                                ℹ️ Info
                            </button>
                        </div>
                    </div>
                `;
            }

            updateStatistics() {
                const total = this.devices.length;
                const connected = this.devices.filter(d => d.status === 'connected').length;
                const wifi = this.devices.filter(d => d.type === 'wifi').length;
                const bluetooth = this.devices.filter(d => d.type === 'bluetooth').length;
                const nfc = this.devices.filter(d => d.type === 'nfc').length;
                const webrtc = this.devices.filter(d => d.type === 'webrtc').length;

                document.getElementById('totalDevices').textContent = total;
                document.getElementById('connectedDevices').textContent = connected;
                document.getElementById('wifiDevices').textContent = wifi;
                document.getElementById('bluetoothDevices').textContent = bluetooth;
                document.getElementById('nfcDevices').textContent = nfc;
                document.getElementById('webrtcDevices').textContent = webrtc;
            }

            startAutoDiscovery() {
                if (!this.settings.autoDiscovery) return;
                
                setInterval(() => {
                    this.performDiscovery();
                }, 30000); // Every 30 seconds
            }

            async performDiscovery() {
                try {
                    // Echte Geräteerkennung über Web APIs
                    const newDevices = await this.scanRealDevices();
                    if (newDevices.length > 0) {
                        this.addLogEntry(`${newDevices.length} neue Geräte gefunden`, 'info');
                        newDevices.forEach(device => {
                            this.devices.push(device);
                        });
                        this.renderDevices();
                        this.updateStatistics();
                        this.saveDevices();
                    }
                } catch (error) {
                    console.error('Fehler bei Geräteerkennung:', error);
                    this.addLogEntry(`Geräteerkennung fehlgeschlagen: ${error.message}`, 'error');
                }
            }

            async scanRealDevices() {
                const newDevices = [];
                
                // Bluetooth-Geräte scannen
                if ('bluetooth' in navigator) {
                    try {
                        const bluetoothDevices = await this.scanBluetoothDevices();
                        newDevices.push(...bluetoothDevices);
                    } catch (error) {
                        console.warn('Bluetooth-Scan fehlgeschlagen:', error);
                    }
                }
                
                // USB-Geräte scannen
                if ('usb' in navigator) {
                    try {
                        const usbDevices = await this.scanUSBDevices();
                        newDevices.push(...usbDevices);
                    } catch (error) {
                        console.warn('USB-Scan fehlgeschlagen:', error);
                    }
                }
                
                // Netzwerk-Geräte scannen
                try {
                    const networkDevices = await this.scanNetworkDevices();
                    newDevices.push(...networkDevices);
                } catch (error) {
                    console.warn('Netzwerk-Scan fehlgeschlagen:', error);
                }
                
                return newDevices;
            }

            async scanBluetoothDevices() {
                const devices = [];
                
                try {
                    const bluetoothDevice = await navigator.bluetooth.requestDevice({
                        acceptAllDevices: true,
                        optionalServices: ['generic_access', 'device_information']
                    });
                    
                    devices.push({
                        id: bluetoothDevice.id,
                        name: bluetoothDevice.name || 'Unbekanntes Bluetooth-Gerät',
                        type: 'bluetooth',
                        status: 'discovered',
                        signal: Math.floor(Math.random() * 100),
                        battery: Math.floor(Math.random() * 100),
                        lastSeen: new Date(),
                        connected: false,
                        capabilities: ['audio', 'data']
                    });
                } catch (error) {
                    // Benutzer hat Geräteauswahl abgebrochen
                }
                
                return devices;
            }

            async scanUSBDevices() {
                const devices = [];
                
                try {
                    const usbDevices = await navigator.usb.getDevices();
                    
                    usbDevices.forEach(device => {
                        devices.push({
                            id: device.serialNumber || Math.random().toString(36),
                            name: device.productName || 'USB-Gerät',
                            type: 'usb',
                            status: 'connected',
                            vendorId: device.vendorId,
                            productId: device.productId,
                            lastSeen: new Date(),
                            connected: true,
                            capabilities: ['data', 'power']
                        });
                    });
                } catch (error) {
                    console.warn('USB-Geräte konnten nicht abgerufen werden:', error);
                }
                
                return devices;
            }

            async scanNetworkDevices() {
                const devices = [];
                
                try {
                    // MDNS/Bonjour-Service-Discovery
                    const response = await fetch('/api/network/devices', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        }
                    });
                    
                    if (response.ok) {
                        const networkDevices = await response.json();
                        networkDevices.forEach(device => {
                            devices.push({
                                id: device.mac || device.ip,
                                name: device.hostname || device.name,
                                type: 'network',
                                status: 'online',
                                ip: device.ip,
                                mac: device.mac,
                                signal: device.signal || 0,
                                lastSeen: new Date(),
                                connected: device.connected || false,
                                capabilities: device.capabilities || ['data']
                            });
                        });
                    }
                } catch (error) {
                    console.warn('Netzwerk-Geräte-Scan fehlgeschlagen:', error);
                }
                
                return devices;
            }

            saveDevices() {
                try {
                    localStorage.setItem('deviceManagerDevices', JSON.stringify(this.devices));
                } catch (error) {
                    console.error('Fehler beim Speichern der Geräte:', error);
                }
            }

            loadDevices() {
                try {
                    const saved = localStorage.getItem('deviceManagerDevices');
                    if (saved) {
                        this.devices = JSON.parse(saved);
                        this.renderDevices();
                    }
                } catch (error) {
                    console.error('Fehler beim Laden der Geräte:', error);
                }
            }

            addLogEntry(message, type = 'info') {
                const log = document.getElementById('connectionLog');
                const time = new Date().toLocaleTimeString();
                
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.innerHTML = `
                    <span class="log-time">${time}</span>
                    <span class="log-message">${message}</span>
                    <span class="log-status log-${type}">${type.toUpperCase()}</span>
                `;
                
                log.insertBefore(entry, log.firstChild);
                
                // Keep only last 20 entries
                while (log.children.length > 20) {
                    log.removeChild(log.lastChild);
                }
            }

            updateSettingsUI() {
                Object.keys(this.settings).forEach(key => {
                    const toggle = document.querySelector(`[onclick="toggleSetting('${key}')"]`);
                    if (toggle) {
                        toggle.classList.toggle('active', this.settings[key]);
                    }
                });
            }

            setupEventListeners() {
                // Add any additional event listeners here
            }
        }

        // Global functions
        function switchTab(tabName) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            window.deviceManager.currentTab = tabName;
        }

        function toggleDevice(deviceId) {
            const device = window.deviceManager.devices.find(d => d.id === deviceId);
            if (device) {
                device.status = device.status === 'connected' ? 'offline' : 'connected';
                device.lastSeen = new Date();
                
                window.deviceManager.renderDevices();
                window.deviceManager.updateStatistics();
                
                const action = device.status === 'connected' ? 'verbunden' : 'getrennt';
                window.deviceManager.addLogEntry(`${device.name} ${action}`, 'success');
            }
        }

        function configureDevice(deviceId) {
            const device = window.deviceManager.devices.find(d => d.id === deviceId);
            if (device) {
                alert(`Konfiguration für ${device.name} wird geöffnet...`);
                window.deviceManager.addLogEntry(`Konfiguration geöffnet: ${device.name}`, 'info');
            }
        }

        function infoDevice(deviceId) {
            const device = window.deviceManager.devices.find(d => d.id === deviceId);
            if (device) {
                const info = `
Geräte-Informationen:
Name: ${device.name}
Typ: ${device.type.toUpperCase()}
MAC: ${device.mac}
Status: ${device.status}
Signal: ${device.signal}/4
Letztes Mal gesehen: ${device.lastSeen.toLocaleString()}
Features: ${device.capabilities.join(', ')}
${device.battery ? `Batterie: ${device.battery}%` : ''}
                `;
                alert(info);
            }
        }

        function toggleSetting(settingName) {
            window.deviceManager.settings[settingName] = !window.deviceManager.settings[settingName];
            window.deviceManager.saveSettings();
            window.deviceManager.updateSettingsUI();
            
            window.deviceManager.addLogEntry(`${settingName} ${window.deviceManager.settings[settingName] ? 'aktiviert' : 'deaktiviert'}`, 'info');
        }

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', () => {
            window.deviceManager = new DeviceManager();
        });
    </script>
        </main>
    
        <script>
            // Browser Navigation Enhancement
            document.addEventListener('DOMContentLoaded', function() {
                // Navigation-Status anzeigen
                updateNavigationStatus();
                
                // Popstate Event für Browser-Navigation
                window.addEventListener('popstate', function(event) {
                    console.log('Browser Navigation:', event.state);
                    updateNavigationStatus();
                });
                
                // Navigation-Status aktualisieren
                function updateNavigationStatus() {
                    const canGoBack = window.history.length > 1;
                    const canGoForward = window.history.length > 1; // Vereinfacht
                    
                    // Back-Button aktivieren/deaktivieren
                    const backButtons = document.querySelectorAll('button[onclick*="history.back"]');
                    backButtons.forEach(btn => {
                        btn.disabled = !canGoBack;
                        btn.style.opacity = canGoBack ? '1' : '0.5';
                    });
                    
                    // Forward-Button aktivieren/deaktivieren
                    const forwardButtons = document.querySelectorAll('button[onclick*="history.forward"]');
                    forwardButtons.forEach(btn => {
                        btn.disabled = !canGoForward;
                        btn.style.opacity = canGoForward ? '1' : '0.5';
                    });
                }
                
                // Globale Navigation-Funktionen
                window.goBack = function() {
                    if (window.history.length > 1) {
                        window.history.back();
                    }
                };
                
                window.goForward = function() {
                    window.history.forward();
                };
                
                window.goHome = function() {
                    window.location.href = '/';
                };
            });
        </script>

    </body>
</html>
