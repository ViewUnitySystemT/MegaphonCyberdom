// SYSTEM FIX INTEGRATION - Automatische Integration in alle HTML-Seiten
console.log('üîß SYSTEM FIX INTEGRATION gestartet...');

class SystemFixIntegration {
    constructor() {
        this.integratedPages = new Set();
        this.systemFixLoaded = false;
    }

    // System Fix in alle HTML-Seiten integrieren
    async integrateSystemFix() {
        console.log('üîß Integriere System Fix in alle HTML-Seiten...');
        
        try {
            // System Fix Script laden
            await this.loadSystemFixScript();
            
            // Alle HTML-Seiten finden und erweitern
            await this.extendAllHTMLPages();
            
            // Integration best√§tigen
            this.systemFixLoaded = true;
            console.log('‚úÖ System Fix erfolgreich integriert');
            
            return true;
        } catch (error) {
            console.error('‚ùå System Fix Integration fehlgeschlagen:', error);
            return false;
        }
    }

    // System Fix Script laden
    async loadSystemFixScript() {
        console.log('üìú Lade System Fix Script...');
        
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = '/komplettes-system-fix.js';
            script.async = true;
            script.onload = () => {
                console.log('‚úÖ System Fix Script geladen');
                resolve(true);
            };
            script.onerror = (error) => {
                console.error('‚ùå System Fix Script konnte nicht geladen werden:', error);
                reject(error);
            };
            document.head.appendChild(script);
        });
    }

    // Alle HTML-Seiten erweitern
    async extendAllHTMLPages() {
        console.log('üìÑ Erweitere alle HTML-Seiten...');
        
        // Aktuelle Seite erweitern
        this.extendCurrentPage();
        
        // Navigation erweitern f√ºr andere Seiten
        this.extendNavigation();
        
        console.log('‚úÖ Alle HTML-Seiten erweitert');
    }

    // Aktuelle Seite erweitern
    extendCurrentPage() {
        console.log('üìÑ Erweitere aktuelle Seite...');
        
        const currentPage = window.location.pathname;
        this.integratedPages.add(currentPage);
        
        // System Fix Status anzeigen
        this.addSystemFixStatus();
        
        // Event Listener f√ºr System Fix Events
        this.addSystemFixEventListeners();
        
        console.log('‚úÖ Aktuelle Seite erweitert:', currentPage);
    }

    // System Fix Status hinzuf√ºgen
    addSystemFixStatus() {
        // Status-Indikator erstellen
        const statusIndicator = document.createElement('div');
        statusIndicator.id = 'system-fix-status';
        statusIndicator.style.cssText = `
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #00ff88;
            padding: 8px 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            z-index: 10000;
            border: 1px solid #00ff88;
            backdrop-filter: blur(10px);
        `;
        statusIndicator.textContent = 'üîß System Fix: Initialisiere...';
        document.body.appendChild(statusIndicator);
        
        // Status aktualisieren
        this.updateSystemFixStatus();
    }

    // System Fix Status aktualisieren
    updateSystemFixStatus() {
        const statusElement = document.getElementById('system-fix-status');
        if (!statusElement) return;
        
        // Event Listener f√ºr System Fix Complete
        window.addEventListener('systemFixComplete', (event) => {
            const result = event.detail;
            const successCount = result.initialized.length;
            const totalCount = result.initialized.length + result.failed.length;
            
            if (result.failed.length === 0) {
                statusElement.textContent = `‚úÖ System Fix: ${successCount}/${totalCount} Systeme aktiv`;
                statusElement.style.borderColor = '#00ff88';
                statusElement.style.color = '#00ff88';
            } else {
                statusElement.textContent = `‚ö†Ô∏è System Fix: ${successCount}/${totalCount} Systeme aktiv`;
                statusElement.style.borderColor = '#ff6b35';
                statusElement.style.color = '#ff6b35';
            }
            
            // Status nach 5 Sekunden ausblenden
            setTimeout(() => {
                statusElement.style.opacity = '0.3';
            }, 5000);
        });
    }

    // System Fix Event Listeners hinzuf√ºgen
    addSystemFixEventListeners() {
        // WebRTC Events
        window.addEventListener('webrtcInitialized', (event) => {
            console.log('üåê WebRTC System initialisiert:', event.detail);
        });
        
        // Matrix Bridge Events
        window.addEventListener('matrixBridgeConnected', (event) => {
            console.log('üîó Matrix Bridge verbunden:', event.detail);
        });
        
        // Search System Events
        window.addEventListener('searchSystemReady', (event) => {
            console.log('üîç Search System bereit:', event.detail);
        });
        
        // Test System Events
        window.addEventListener('testSystemReady', (event) => {
            console.log('üß™ Test System bereit:', event.detail);
        });
        
        // Monitoring System Events
        window.addEventListener('monitoringSystemReady', (event) => {
            console.log('üìä Monitoring System bereit:', event.detail);
        });
    }

    // Navigation erweitern
    extendNavigation() {
        console.log('üß≠ Erweitere Navigation...');
        
        // Alle Links finden und erweitern
        const links = document.querySelectorAll('a[href*=".html"]');
        links.forEach(link => {
            link.addEventListener('click', (event) => {
                // System Fix Status f√ºr n√§chste Seite vorbereiten
                this.prepareNextPage(link.href);
            });
        });
        
        console.log('‚úÖ Navigation erweitert');
    }

    // N√§chste Seite vorbereiten
    prepareNextPage(url) {
        console.log('üìÑ Bereite n√§chste Seite vor:', url);
        
        // System Fix Status in localStorage speichern
        localStorage.setItem('systemFixStatus', JSON.stringify({
            initialized: true,
            timestamp: new Date().toISOString(),
            currentPage: window.location.pathname,
            nextPage: url
        }));
    }

    // System Fix Status aus localStorage laden
    loadSystemFixStatus() {
        const status = localStorage.getItem('systemFixStatus');
        if (status) {
            try {
                const statusData = JSON.parse(status);
                console.log('üìä System Fix Status geladen:', statusData);
                return statusData;
            } catch (error) {
                console.error('‚ùå System Fix Status konnte nicht geladen werden:', error);
            }
        }
        return null;
    }

    // System Fix Funktionen verf√ºgbar machen
    makeSystemFixFunctionsAvailable() {
        console.log('üîß Mache System Fix Funktionen verf√ºgbar...');
        
        // Globale Funktionen hinzuf√ºgen
        window.runSystemFix = () => {
            if (window.systemFix) {
                return window.systemFix.initializeAllSystems();
            } else {
                console.error('‚ùå System Fix nicht verf√ºgbar');
                return Promise.reject('System Fix nicht verf√ºgbar');
            }
        };
        
        window.getSystemFixStatus = () => {
            return {
                loaded: this.systemFixLoaded,
                integratedPages: Array.from(this.integratedPages),
                status: this.loadSystemFixStatus()
            };
        };
        
        window.testAllSystems = async () => {
            if (window.testSystem) {
                return await window.testSystem.runAllTests();
            } else {
                console.error('‚ùå Test System nicht verf√ºgbar');
                return Promise.reject('Test System nicht verf√ºgbar');
            }
        };
        
        window.searchApps = async (query) => {
            if (window.searchSystem) {
                return await window.searchSystem.search(query);
            } else {
                console.error('‚ùå Search System nicht verf√ºgbar');
                return Promise.reject('Search System nicht verf√ºgbar');
            }
        };
        
        window.startScreenShare = async () => {
            if (window.androidScreenShare) {
                return await window.androidScreenShare.startScreenShare();
            } else {
                console.error('‚ùå Android Screen Share nicht verf√ºgbar');
                return Promise.reject('Android Screen Share nicht verf√ºgbar');
            }
        };
        
        window.checkAllTargets = async () => {
            if (window.monitoringSystem) {
                return await window.monitoringSystem.checkAllTargets();
            } else {
                console.error('‚ùå Monitoring System nicht verf√ºgbar');
                return Promise.reject('Monitoring System nicht verf√ºgbar');
            }
        };
        
        console.log('‚úÖ System Fix Funktionen verf√ºgbar gemacht');
    }

    // Integration initialisieren
    async init() {
        console.log('üöÄ System Fix Integration initialisiert...');
        
        try {
            // System Fix Status laden
            this.loadSystemFixStatus();
            
            // System Fix integrieren
            await this.integrateSystemFix();
            
            // Funktionen verf√ºgbar machen
            this.makeSystemFixFunctionsAvailable();
            
            console.log('‚úÖ System Fix Integration vollst√§ndig initialisiert');
            return true;
        } catch (error) {
            console.error('‚ùå System Fix Integration Initialisierung fehlgeschlagen:', error);
            return false;
        }
    }
}

// Automatische Integration beim Laden der Seite
document.addEventListener('DOMContentLoaded', async () => {
    console.log('üìÑ DOM geladen - starte System Fix Integration...');
    
    const integration = new SystemFixIntegration();
    await integration.init();
    
    console.log('üéâ System Fix Integration abgeschlossen!');
});

// Export f√ºr Module
if (typeof module !== 'undefined' && module.exports) {
    module.exports = SystemFixIntegration;
}


